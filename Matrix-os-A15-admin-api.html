matrix-os A15 admin.  api system
# matrix-OS-A15-admin-api.py
# Matrix Windows Admin API (Flask)
# Provides admin endpoints: users (CRUD-lite) & sessions
# Matrix Instruction Manual, ARM Index, Volume 1

from flask import Flask, request, jsonify
import importlib.util
from pathlib import Path

APP_DIR = Path(__file__).parent.resolve()

def load_module(module_name: str, filename: str):
    path = APP_DIR / filename
    spec = importlib.util.spec_from_file_location(module_name, str(path))
    if spec is None or spec.loader is None:
        raise ImportError(f"Could not load spec for {filename}")
    mod = importlib.util.module_from_spec(spec)
    spec.loader.exec_module(mod)
    return mod

# Load DB (A5) and Security (A3)
db = load_module("matrix_os_a5_database", "matrix-OS-A5-database.py")
sec = load_module("matrix_os_a3_security", "matrix-OS-A3-security.py")

app = Flask(__name__)

def ok(data=None, **extra):
    payload = {"ok": True}
    if data is not None:
        payload["data"] = data
    payload.update(extra)
    return jsonify(payload)

def err(message, code=400):
    return jsonify({"ok": False, "error": message}), code

# ---- USERS ----

@app.route("/api/admin/users", methods=["GET"])
def admin_list_users():
    try:
        return ok(users=db.list_users())
    except Exception as e:
        return err(f"Failed to list users: {e}", 500)

@app.route("/api/admin/user", methods=["GET"])
def admin_get_user():
    username = (request.args.get("username") or "").strip()
    if not username:
        return err("Missing ?username= parameter")
    try:
        user = db.get_user(username)
        if not user:
            return err("User not found", 404)
        return ok(user=user)
    except Exception as e:
        return err(f"Failed to fetch user: {e}", 500)

@app.route("/api/admin/user", methods=["POST"])
def admin_upsert_user():
    """
    JSON body:
    {
      "username": "Admin",
      "voiceprint": "9a8b7c6d5e4f",
      "iris": "ZXCY-1122-9900",
      "face_hash": "6df9b2a31c",
      "security_lvl": 3
    }
    """
    data = request.get_json(silent=True) or {}
    username = (data.get("username") or "").strip()
    voice    = (data.get("voiceprint") or "").strip()
    iris     = (data.get("iris") or "").strip()
    face     = (data.get("face_hash") or "").strip()
    level    = int(data.get("security_lvl") or 1)

    if not (username and voice and iris and face):
        return err("Missing required fields: username, voiceprint, iris, face_hash")

    try:
        db.init_db()  # ensure table exists
        db.upsert_user(username, voice, iris, face, level)
        return ok(message="User upserted", user=db.get_user(username))
    except Exception as e:
        return err(f"Failed to upsert user: {e}", 500)

@app.route("/api/admin/user/security", methods=["POST"])
def admin_update_security():
    """
    JSON body:
    { "username": "Admin", "security_lvl": 3 }
    """
    data = request.get_json(silent=True) or {}
    username = (data.get("username") or "").strip()
    level    = data.get("security_lvl")
    try:
        level = int(level)
    except Exception:
        return err("security_lvl must be an integer")

    if not username:
        return err("Missing username")
    try:
        success = db.update_security_level(username, level)
        if not success:
            return err("User not found or not updated", 404)
        return ok(message="Security level updated", user=db.get_user(username))
    except Exception as e:
        return err(f"Failed to update level: {e}", 500)

# ---- SESSIONS ----

@app.route("/api/admin/sessions", methods=["GET"])
def admin_list_sessions():
    """
    Returns the in-memory sessions dict from A3.
    Note: A3 stores sessions in sec.active_sessions
    """
    try:
        # Pretty-printed JSON string is returned by sec.list_sessions()
        # For convenience, also return parsed dict
        import json as _json
        raw = sec.list_sessions()  # string
        parsed = {}
        try:
            parsed = _json.loads(raw)
        except Exception:
            pass
        return ok(sessions=parsed, raw=raw)
    except Exception as e:
        return err(f"Failed to list sessions: {e}", 500)

@app.route("/api/admin/session/revoke", methods=["POST"])
def admin_revoke_session():
    """
    JSON body:
    { "token": "<session token>" }
    """
    data = request.get_json(silent=True) or {}
    token = (data.get("token") or "").strip()
    if not token:
        return err("Missing token")
    try:
        success = sec.revoke_session(token)
        if not success:
            return err("Invalid or already revoked token", 400)
        return ok(message="Session revoked", token=token)
    except Exception as e:
        return err(f"Failed to revoke session: {e}", 500)

# ---- CORS ----
@app.after_request
def add_cors(resp):
    resp.headers["Access-Control-Allow-Origin"] = "*"
    resp.headers["Access-Control-Allow-Headers"] = "Content-Type"
    resp.headers["Access-Control-Allow-Methods"] = "GET, POST, OPTIONS"
    return resp

if __name__ == "__main__":
    # Run: python matrix-OS-A15-admin-api.py
    # Example endpoints:
    #   GET  http://127.0.0.1:5090/api/admin/users
    #   GET  http://127.0.0.1:5090/api/admin/user?username=Admin
    #   POST http://127.0.0.1:5090/api/admin/user
    #   POST http://127.0.0.1:5090/api/admin/user/security
    #   GET  http://127.0.0.1:5090/api/admin/sessions
    #   POST http://127.0.0.1:5090/api/admin/session/revoke
    app.run(host="127.0.0.1", port=5090, debug=True)
